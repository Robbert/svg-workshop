<!DOCTYPE html>
<meta charset="utf-8">
<h1>SVG workshop</h1>
<h2>Source SVG</h2>
<p>The plan is to generate SVG sprites automatically for SVG elements that have an <code>id</code> attribute. I'm going to use <code>svgEl.getBBox()</code> to get the coordinates of the sprite, and generate a <code>viewBox</code> for those coordinates.</p>

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" width="195.8" height="32" viewBox="0 0 195.8 32">
  <title>smiley-sprite</title>
  <g id="smiley--surprised">
    <path d="M148.5,33.2a16,16,0,1,0-16-16A16,16,0,0,0,148.5,33.2Zm0-29a13,13,0,1,1-13,13A13,13,0,0,1,148.5,4.2Z" transform="translate(-1 -1.2)" fill="#444"/>
    <path d="M152.5,22.2c0,2.8-1.8,5-4,5s-4-2.2-4-5,1.8-5,4-5S152.5,19.4,152.5,22.2Z" transform="translate(-1 -1.2)" fill="#444"/>
    <path d="M145.5,11.8a1,1,0,0,1-.7-0.3,2.1,2.1,0,0,0-2.6,0,1,1,0,1,1-1.4-1.4,4,4,0,0,1,5.4,0A1,1,0,0,1,145.5,11.8Z" transform="translate(-1 -1.2)" fill="#444"/>
    <path d="M155.5,11.8a1,1,0,0,1-.7-0.3,2.1,2.1,0,0,0-2.6,0,1,1,0,0,1-1.4-1.4,4,4,0,0,1,5.4,0A1,1,0,0,1,155.5,11.8Z" transform="translate(-1 -1.2)" fill="#444"/>
  </g>
  <g id="smiley--mustache">
    <path d="M83,33.2a16,16,0,1,0-16-16A16,16,0,0,0,83,33.2Zm0-29a13,13,0,1,1-13,13A13,13,0,0,1,83,4.2Zm-8,7a2,2,0,1,1,2,2A2,2,0,0,1,75,11.2Zm12,0a2,2,0,1,1,2,2A2,2,0,0,1,87,11.2Z" transform="translate(-1 -1.2)" fill="#444"/>
    <path d="M88.1,18a3,3,0,1,0-4.2,4.2H84c2.7,2.5,9-.1,9-3.2-1.9,1.3-3.5.3-4.9-1.1h0Z" transform="translate(-1 -1.2)" fill="#444"/>
    <path d="M77.9,18a3,3,0,0,1,4.2,4.2H82c-2.7,2.5-9-.1-9-3.2,1.9,1.3,3.5.3,4.9-1.1h0Z" transform="translate(-1 -1.2)" fill="#444"/>
  </g>
  <g id="smiley--happy">
    <path d="M50,33.2a16,16,0,1,0-16-16A16,16,0,0,0,50,33.2Zm0-29a13,13,0,1,1-13,13A13,13,0,0,1,50,4.2Zm0,15.7a20,20,0,0,0,10-2.7c-0.5,5.6-4.8,9.9-10,9.9s-9.5-4.4-10-9.9a20,20,0,0,0,10,2.7h0Zm-8-7.7c0-1.7.9-3,2-3s2,1.3,2,3-0.9,3-2,3S42,13.8,42,12.2Zm12,0c0-1.7.9-3,2-3s2,1.3,2,3-0.9,3-2,3S54,13.8,54,12.2Z" transform="translate(-1 -1.2)" fill="#444"/>
  </g>
  <g id="smiley--grin">
    <path d="M115.8,33.2a16,16,0,1,0-16-16A16,16,0,0,0,115.8,33.2Zm0-29a13,13,0,1,1-13,13A13,13,0,0,1,115.8,4.2Zm-10,13v2a8,8,0,0,0,8,8h4a8,8,0,0,0,8-8v-2h-20Zm6,7.7a6,6,0,0,1-2.2-1.4,6,6,0,0,1-1.8-4.2h4v5.7Zm6,0.3h-4v-6h4v6Zm4.2-1.8a6,6,0,0,1-2.2,1.4V19.2h4A6,6,0,0,1,122,23.4ZM106.8,13.2h0a0.6,0.6,0,0,0,.6-0.5,2.4,2.4,0,0,1,4.7,0,0.6,0.6,0,0,0,1.2,0,3.6,3.6,0,1,0-7.1,0,0.6,0.6,0,0,0,.6.5h0Zm12,0h0a0.6,0.6,0,0,0,.6-0.5,2.4,2.4,0,0,1,4.7,0,0.6,0.6,0,0,0,1.2,0,3.6,3.6,0,1,0-7.1,0,0.6,0.6,0,0,0,.6.5h0Z" transform="translate(-1 -1.2)" fill="#444"/>
  </g>
  <g id="smiley--glasses">
    <path d="M17,33.2a16,16,0,1,0-16-16A16,16,0,0,0,17,33.2Zm0-29a13,13,0,1,1-13,13A13,13,0,0,1,17,4.2Zm9,5a1,1,0,0,1,1,1v3a2,2,0,0,1-2,2H21a2,2,0,0,1-2-2H15a2,2,0,0,1-2,2H9a2,2,0,0,1-2-2v-3a1,1,0,0,1,1-1h6a1,1,0,0,1,1,1v1h4v-1a1,1,0,0,1,1-1h6Zm-9,16a8,8,0,0,0,6.9-3.9l1.7,1a10,10,0,0,1-12.8,3.9l1-1.7a8,8,0,0,0,3.2.7h0Z" transform="translate(-1 -1.2)" fill="#444"/>
  </g>
  <g id="smiley--shocked">
    <path d="M180.8,33.2a16,16,0,1,0-16-16A16,16,0,0,0,180.8,33.2Zm0-29a13,13,0,1,1-13,13A13,13,0,0,1,180.8,4.2Z" transform="translate(-1 -1.2)" fill="#444"/>
    <path d="M176.8,14.2a1,1,0,1,1-1-1A1,1,0,0,1,176.8,14.2Z" transform="translate(-1 -1.2)" fill="#444"/>
    <path d="M175.8,11.2a3,3,0,1,1-3,3A3,3,0,0,1,175.8,11.2Zm0-2a5,5,0,1,0,5,5,5,5,0,0,0-5-5h0Z" transform="translate(-1 -1.2)" fill="#444"/>
    <path d="M186.8,14.2a1,1,0,1,1-1-1A1,1,0,0,1,186.8,14.2Z" transform="translate(-1 -1.2)" fill="#444"/>
    <path d="M185.8,11.2a3,3,0,1,1-3,3A3,3,0,0,1,185.8,11.2Zm0-2a5,5,0,1,0,5,5,5,5,0,0,0-5-5h0Z" transform="translate(-1 -1.2)" fill="#444"/>
    <path d="M176.8,23.2h8v2h-8v-2Z" transform="translate(-1 -1.2)" fill="#444"/>
  </g>


  <view id='happy-smiley' viewBox='34 0 31 33' />
  <!-- define more views here... -->
</svg>

<h2>Example of generated sprites</h2>
<div id="generated">
</div>
<script src="autosprite.js"></script>
<style>
section {
  border: 2px solid green;
  padding: 2em;
  margin-top: 2em;
}
:root {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}
script, pre {
  font-family: 'Monaco', monospace;
  font-size: 0.8em;
}
body {
  padding: 2em 4em 8em 4em;
}
script.view-source {
  display: block;
  white-space: pre;
}
</style>
<script class="view-source">
const imgLocation = 'sprites.svg';

const XMLNS_SVG = 'http://www.w3.org/2000/svg';
const XMLNS_XLINK = 'http://www.w3.org/1999/xlink';

const svgElement = (nodeName) => document.createElementNS(XMLNS_SVG, nodeName);
const xlinkAttr = (el, attrName, value) => el.setAttributeNS(XMLNS_XLINK, attrName, value);

const parent = (el, selector) => {
  let parent;
  while ((parent = el.parentNode) && parent) {
    if (parent.matches && parent.matches(selector)) {
      return parent;
    }
  }
  return null;
}

const hasBBoxFn = el => typeof el.getBBox === 'function';

const createSprite1 = (el, id, bbox) => {

  const svg = parent(el, 'svg');

  const view = svgElement('view');
  const viewBox = [
    bbox.x,
    bbox.y,
    bbox.width,
    bbox.height
  ].map(Math.round).join(' ');

  view.setAttribute('id', `${id}-view`);
  view.setAttribute('viewBox', viewBox);

  svg.appendChild(view);

  const img = new Image();

  const blob = new Blob([svg.outerHTML], { type: 'image/svg+xml' });
  const blobURL = URL.createObjectURL(blob);

  img.src = `${blobURL}#${id}-view`;
  img.width = bbox.width;
  img.height = bbox.height;

  return img;
};

const createSprite2 = (el, id, bbox) => {

  const viewBox = [
    bbox.x,
    bbox.y,
    bbox.width,
    bbox.height
  ].map(Math.round).join(', ');

  const img = new Image();

  img.src = `${imgLocation}#svgView(viewBox(${viewBox}))`;
  img.width = bbox.width;
  img.height = bbox.height;

  return img;

};


const createSprite3 = (el, id, bbox) => {

  const sprite = svgElement('svg');
  const use = svgElement('use');

  sprite.appendChild(use);
  xlinkAttr(use, 'href', `#${id}`);

  const viewBox = [
    bbox.x,
    bbox.y,
    bbox.width,
    bbox.height
  ].map(Math.round).join(' ');

  sprite.setAttribute('viewBox', viewBox);
  sprite.setAttribute('height', Math.round(bbox.height));
  sprite.setAttribute('width', Math.round(bbox.width));

  return sprite;

};

document.addEventListener('DOMContentLoaded', () => {

  const createExample = (technique, svg) => {
    // TODO: Exclude elements with an `id`, that contain other elements with an `id`

    const section = document.createElement('section');
    const heading = document.createElement('h2');
    heading.textContent = technique.title;
    section.appendChild(heading);
    const para = document.createElement('p');
    para.textContent = technique.desc;
    section.appendChild(para);
    const idRoots = Array.from(svg.querySelectorAll('[id]'));

    const renderSprite = (sprite) => {

      const container = document.createElement('p');

      container.appendChild(sprite);

      section.appendChild(container);

      const pre = document.createElement('pre');
      pre.textContent = container.innerHTML;
      section.appendChild(pre);

    };

    const createSprite = (el) => {

      const bbox = el.getBBox();

      return technique.converter(el, el.id, bbox);

    };

    idRoots
      .filter(hasBBoxFn)
      .map(createSprite)
      .filter(Boolean)
      .forEach(renderSprite);

    document.getElementById('generated').appendChild(section);

  };

  const svg = document.querySelector('svg');

  const techniques = [
    {
      title: 'technique #1',
      desc: 'Generate a <view id="xyz" viewBox="..."> element in the SVG, and refer to it '
          + 'using <img src=example.svg#xy`>. Because in this example I add the <view> '
          + 'element in an embedded <svg>, I needed to create a blob URL to be able to use '
          + 'the fragment identifier. Just <img src="#xyz"> did not work.',
      converter: createSprite1
    },
    {
      title: 'technique #2',
      desc: 'This approach is similar to the <view> technique, but when the sprite elements '
          + 'in SVG already have id attributes, it does not require any modifications to the'
          + ' SVG file.',
      converter: createSprite2
    },
    {
      title: 'technique #3',
      desc: 'This is a technique that is similar to viewBox fragment identifier URLs, '
          + 'but for browsers that do not support those URLs.',
      converter: createSprite3
    }
  ];

  techniques.forEach((technique) => createExample(technique, svg));

});

</script>

<a href="https://github.com/Robbert/svg-workshop"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png"></a>
